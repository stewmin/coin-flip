<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault Street v1.0 Beta</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
  <style>
    /* Basic Styles */
    body {
      margin: 0;
      font-family: 'Press Start 2P', cursive;
      background: #111;
      color: white;
    }
    header {
      text-align: center;
      background: #000;
      padding: 20px;
      border-bottom: 2px solid gold;
    }
    .container {
      max-width: 960px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .section {
      margin-top: 30px;
      padding: 15px;
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 10px;
    }
    button, input, select {
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      padding: 6px 10px;
      margin: 5px 0;
      cursor: pointer;
    }
    input, select {
      background: #ddd;
      color: #000;
    }
    footer {
      text-align: center;
      background: #000;
      padding: 20px;
      font-size: 10px;
      margin-top: 40px;
      color: gray;
    }
    /* New Vault Clock Display */
    #vaultClockDisplay {
      font-size: 12px;
      color: cyan;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üèõÔ∏è Vault Street v1.0 Beta</h1>
  </header>
  
  <!-- Minted Stats Area -->
  <div id="mintedStats" style="text-align: center; background: #222; padding: 5px; font-size: 10px;">
    <p id="totalMinted">Total Minted: Loading...</p>
    <p id="todayMinted">Minted Today: Loading...</p>
  </div>
  
  <!-- Market Ticker -->
  <div id="marketTicker" style="background: black; color: gold; padding: 5px; font-size: 10px; white-space: nowrap; overflow: hidden;">
    <marquee id="tradeTicker" scrollamount="4">Vault Street Market ‚Äî Loading...</marquee>
  </div>
  
  <div class="container">
    <!-- Authentication Panel -->
    <div id="auth-panel" class="section">
      <h2>Login / Register</h2>
      <input type="email" id="email" placeholder="Email" /><br/>
      <input type="password" id="password" placeholder="Password" /><br/>
      <input type="text" id="username" placeholder="Choose Username" /><br/>
      <!-- BLOCK: Vault Type Registration -->
      <div class="vaultTypeSelect">
        <label for="vaultType">Select Your Vault Type:</label>
        <select id="vaultType">
          <option value="Basic">Basic Vault</option>
          <option value="Investment">Investment Vault</option>
          <option value="Holdings">Holdings Vault</option>
        </select>
      </div>
      <button onclick="login()">Login / Register</button>
    </div>
    
    <!-- User Panel -->
    <div id="user-panel" class="section" style="display: none;">
      <div style="text-align: right;"><button onclick="logout()">Logout</button></div>
      <h2>Welcome, <span id="displayName"></span></h2>
      
      <!-- BLOCK: Vault Type & Customization -->
      <div id="vaultInfo">
        <p>Your Vault Type: <span id="vaultTypeDisplay"></span></p>
        <!-- Vault Clock Display -->
        <div id="vaultClockDisplay">Vault Clock: Loading...</div>
        <!-- BLOCK: Vault Theme Customization -->
        <div id="vaultThemeSection">
          <h3>Customize Your Vault Theme</h3>
          <select id="vaultTheme">
            <option value="default">Gray Default</option>
            <option value="red">Red</option>
            <option value="blue">Blue</option>
            <option value="green">Green</option>
          </select>
          <button onclick="updateVaultTheme()">Apply Theme</button>
        </div>
      </div>
      
      <!-- Coin Minting Section -->
      <div id="mintingSection" class="section">
        <h3>Mint a Coin</h3>
        <button id="mintBtn" onclick="mintNewCoin()" disabled>Mint New Coin</button>
        <p id="mintNotice" style="color: red; font-size: 10px;">Minting disabled until market criteria met.</p>
      </div>
      
      <!-- Vault Summary -->
      <div id="vaultSummary" class="section">
        <h3>My Vault</h3>
        <div id="vaultCoins">
          <!-- Coin counts will be displayed here -->
        </div>
        <p id="vaultRatio"></p>
      </div>
      
      <!-- Trading Portal (Retained from previous design) -->
      <div id="tradePortal" class="section" style="display: none;">
        <h3>Trading Portal</h3>
        <div id="tradeRequestForm">
          <h4>Create Trade Request</h4>
          <label>Offer Coin Type:</label>
          <select id="tradeOfferType">
            <option>Copper</option>
            <option>Silver</option>
            <option>Gold</option>
            <option>Platinum</option>
            <option>Diamond</option>
            <option>Iridium</option>
            <option>Rhodium</option>
          </select><br/>
          <label>Offer Quantity:</label>
          <input type="number" id="tradeOfferQty" min="1" value="1"/><br/>
          <label>Request Coin Type:</label>
          <select id="tradeRequestType">
            <option>Copper</option>
            <option>Silver</option>
            <option>Gold</option>
            <option>Platinum</option>
            <option>Diamond</option>
            <option>Iridium</option>
            <option>Rhodium</option>
          </select><br/>
          <label>Request Quantity:</label>
          <input type="number" id="tradeRequestQty" min="1" value="1"/><br/>
          <button onclick="submitTradeRequest()">Submit Trade Request</button>
        </div>
        <div id="tradeRequestsList">
          <!-- Trade requests will appear here -->
        </div>
      </div>
      <button id="toggleTradePortalButton" onclick="toggleTradePortal()">Open Trading Portal</button>
    </div>
    
  </div>
  
  <footer>
    <p>&copy; 2025 Vault Street</p>
  </footer>
  
  <!-- Audio Elements -->
  <audio id="bgMusic" loop>
    <source src="bg-music.mp3" type="audio/mpeg">
  </audio>
  <audio id="sfxMint">
    <source src="sfx-mint.mp3" type="audio/mpeg">
  </audio>
  <audio id="sfxTrade">
    <source src="sfx-trade.mp3" type="audio/mpeg">
  </audio>
  
  <script>
    // === Firebase Initialization ===
    const firebaseConfig = {
      apiKey: "AIzaSyDfZZUf2pY9ueCx6Q7m86dnitU_voims-8",
      authDomain: "coin-flip-4a693.firebaseapp.com",
      databaseURL: "https://coin-flip-4a693-default-rtdb.firebaseio.com",
      projectId: "coin-flip-4a693",
      storageBucket: "coin-flip-4a693.appspot.com",
      messagingSenderId: "572907715515",
      appId: "1:572907715515:web:68a53fc5a8e4b5157fe29e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // === Global Variables ===
    let currentUsername = "";
    let currentVaultType = ""; // Basic, Investment, or Holdings
    let canMint = false;
    
    // ---- Helper Functions ----
    function getRatioColor(ratio) {
      if (ratio < 1.0) return "red";
      else if (ratio <= 1.5) return "yellow";
      else return "green";
    }
    
    // Returns rarity as before
    function getRarity() {
      const roll = Math.random() * 100;
      if (roll < 50) return "Copper";
      else if (roll < 75) return "Silver";
      else if (roll < 87) return "Gold";
      else if (roll < 94) return "Platinum";
      else if (roll < 97) return "Diamond";
      else if (roll < 99) return "Iridium";
      else return "Rhodium";
    }
    
    // ---- Vault Clock System ----
    // Demo cycle set to 5 minutes (300 seconds). Adjust cycleLength as needed.
    const cycleLength = 300; // in seconds
    let clockStartTime = Date.now();
    function updateVaultClock() {
      const elapsed = Math.floor((Date.now() - clockStartTime) / 1000);
      let remaining = cycleLength - (elapsed % cycleLength);
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      document.getElementById("vaultClockDisplay").textContent = 
        "Vault Clock: " + minutes.toString().padStart(2, "0") + ":" + seconds.toString().padStart(2, "0");
      
      // When cycle restarts, trigger reset events.
      if (elapsed % cycleLength === 0) {
        vaultClockReset();
      }
    }
    function vaultClockReset() {
      console.log("Vault Clock Reset Triggered");
      // PLACE BLOCK HERE: Add reset actions (e.g., return unfulfilled market sales, reset theme prices, enable coin conversion)
      cleanupExpiredTradeRequests(); // Placeholder action.
    }
    setInterval(updateVaultClock, 1000);
    updateVaultClock();
    
    // ---- Vault Theme Customization ----
    function updateVaultTheme() {
      const theme = document.getElementById("vaultTheme").value;
      // For demo, change user-panel background color.
      const userPanel = document.getElementById("user-panel");
      switch(theme) {
        case "red": userPanel.style.backgroundColor = "#330000"; break;
        case "blue": userPanel.style.backgroundColor = "#000033"; break;
        case "green": userPanel.style.backgroundColor = "#003300"; break;
        default: userPanel.style.backgroundColor = "#1a1a1a";
      }
      // Save theme to Firebase.
      if (auth.currentUser) {
        db.ref("users/" + auth.currentUser.uid).update({ theme: theme });
      }
    }
    
    // ---- Authentication & Registration ----
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("auth-panel").style.display = "none";
        document.getElementById("user-panel").style.display = "block";
        db.ref("users/" + user.uid).once("value").then(snap => {
          const data = snap.val() || {};
          // Set vault type; if not set, use selection from auth panel.
          if (data.vaultType) {
            currentVaultType = data.vaultType;
          } else {
            currentVaultType = document.getElementById("vaultType").value;
            db.ref("users/" + user.uid).update({ vaultType: currentVaultType });
          }
          document.getElementById("vaultTypeDisplay").textContent = currentVaultType;
          currentUsername = data.username || "";
          if (!currentUsername) {
            currentUsername = document.getElementById("username").value.trim() || user.email.split("@")[0];
            db.ref("users/" + user.uid).update({ username: currentUsername });
          }
          document.getElementById("displayName").textContent = currentUsername;
          updateMintAccess();
          loadVault();
        });
      } else {
        document.getElementById("auth-panel").style.display = "block";
        document.getElementById("user-panel").style.display = "none";
      }
    });
    function login() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      const usernameInput = document.getElementById("username").value.trim();
      const vaultTypeInput = document.getElementById("vaultType").value;
      auth.signInWithEmailAndPassword(email, pass).catch(() => {
        auth.createUserWithEmailAndPassword(email, pass)
          .then(cred => {
            currentUsername = usernameInput || email.split("@")[0];
            currentVaultType = vaultTypeInput;
            db.ref("users/" + cred.user.uid).set({
              email: cred.user.email,
              username: currentUsername,
              vaultType: currentVaultType,
              theme: "default"
            });
          })
          .catch(err => alert(err.message));
      });
    }
    function logout() {
      auth.signOut();
    }
    
    // ---- Coin Minting & Vault Functions ----
    const registryRef = db.ref("mintRegistry");
    const mintedRef = db.ref("mintedCount");
    function updateMintAccess() {
      // Simplified: allow minting if market ratio > 1.0 (placeholder logic)
      db.ref("tradeStats").once("value").then(snap => {
        const data = snap.val() || {};
        const avgRatio = data.averageTradeRatio || 1.0;
        canMint = avgRatio > 1.0;
        document.getElementById("mintBtn").disabled = !canMint;
        document.getElementById("mintNotice").style.display = canMint ? "none" : "block";
      });
    }
    function mintNewCoin(callback) {
      const user = auth.currentUser;
      if (!user || !canMint) return;
      mintedRef.once("value").then(snap => {
        const serial = (snap.val() || 0) + 1;
        const rarity = getRarity();
        const now = new Date().toISOString();
        const coinData = { serial, rarity, date: now };
        registryRef.child("coin_" + serial).set(coinData);
        db.ref("users/" + user.uid + "/coins").child("coin_" + serial).set(coinData);
        mintedRef.set(serial);
        playSFX('sfxMint');
        if (callback) callback();
      });
    }
    function loadVault() {
      const user = auth.currentUser;
      if (!user) return;
      db.ref("users/" + user.uid + "/coins").once("value").then(snap => {
        const data = snap.val() || {};
        const counts = { Copper: 0, Silver: 0, Gold: 0, Platinum: 0, Diamond: 0, Iridium: 0, Rhodium: 0 };
        Object.values(data).forEach(coin => {
          if (coin && coin.rarity) counts[coin.rarity] = (counts[coin.rarity] || 0) + 1;
        });
        let summary = "";
        for (let r in counts) {
          summary += `<p>${r}: ${counts[r]}</p>`;
        }
        document.getElementById("vaultCoins").innerHTML = summary;
        updateVaultRatio();
      });
    }
    function updateVaultRatio() {
      const user = auth.currentUser;
      if (!user) return;
      db.ref("users").once("value").then(snapshot => {
        let totalScore = 0, countUsers = 0;
        snapshot.forEach(userSnap => {
          const coins = userSnap.val().coins;
          totalScore += calculateVaultScore(coins);
          countUsers++;
        });
        const avgScore = countUsers ? (totalScore / countUsers) : 0;
        db.ref("users/" + user.uid + "/coins").once("value").then(snap => {
          const currentScore = calculateVaultScore(snap.val());
          const ratio = avgScore ? (currentScore / avgScore) : 1;
          const vaultRatioEl = document.getElementById("vaultRatio");
          vaultRatioEl.textContent = "My Vault Ratio: " + ratio.toFixed(2);
          vaultRatioEl.style.color = getRatioColor(ratio);
        });
      });
    }
    function calculateVaultScore(coins) {
      if (!coins) return 0;
      const rarityValues = { Copper: 1, Silver: 2, Gold: 3, Platinum: 4, Diamond: 5, Iridium: 6, Rhodium: 7 };
      let score = 0, owned = new Set();
      Object.values(coins).forEach(c => {
        if (c && c.rarity) { score += rarityValues[c.rarity] || 0; owned.add(c.rarity); }
      });
      if (owned.size === 7) score += 5; // Bonus for full set.
      return score;
    }
    
    // ---- Trading Functions (Simplified) ----
    const TRADE_EXPIRATION_MS = 3600000; // 1 hour
    function submitTradeRequest() {
      const user = auth.currentUser;
      if (!user) { alert("You must be logged in."); return; }
      const offerType = document.getElementById("tradeOfferType").value;
      const offerQty = parseInt(document.getElementById("tradeOfferQty").value);
      const requestType = document.getElementById("tradeRequestType").value;
      const requestQty = parseInt(document.getElementById("tradeRequestQty").value);
      if (offerQty < 1 || requestQty < 1) { alert("Enter valid quantities."); return; }
      db.ref("users/" + user.uid + "/coins").once("value").then(snap => {
        const vaultData = snap.val();
        if (!vaultData) { alert("Your vault is empty."); return; }
        let available = [];
        Object.entries(vaultData).forEach(([id, coin]) => {
          if (coin.rarity === offerType && available.length < offerQty) {
            available.push({ id, coin });
          }
        });
        if (available.length < offerQty) { alert("Not enough " + offerType + " coins."); return; }
        available.forEach(item => { db.ref("users/" + user.uid + "/coins/" + item.id).remove(); });
        const tradeRequest = {
          requesterUid: user.uid,
          requesterUsername: currentUsername,
          offer: { coinType: offerType, quantity: offerQty, reserved: available.map(a => a.coin) },
          request: { coinType: requestType, quantity: requestQty },
          timestamp: Date.now(),
          expiration: Date.now() + TRADE_EXPIRATION_MS
        };
        db.ref("tradeRequests").push(tradeRequest, err => {
          if (err) alert("Trade request failed."); else alert("Trade request submitted.");
        });
      });
    }
    function toggleTradePortal() {
      const portal = document.getElementById("tradePortal");
      const btn = document.getElementById("toggleTradePortalButton");
      if (!portal.style.display || portal.style.display === "none") {
        portal.style.display = "block";
        btn.textContent = "Close Trading Portal";
      } else {
        portal.style.display = "none";
        btn.textContent = "Open Trading Portal";
      }
    }
    function listenTradeRequests() {
      db.ref("tradeRequests").on("value", snap => {
        const data = snap.val();
        const listDiv = document.getElementById("tradeRequestsList");
        listDiv.innerHTML = "";
        if (!data) { listDiv.innerHTML = "<p>No pending trade requests.</p>"; return; }
        Object.entries(data).forEach(([key, req]) => {
          if (Date.now() > req.expiration) return;
          const minutesLeft = ((req.expiration - Date.now()) / 60000).toFixed(1);
          let html = `<p>${req.requesterUsername} offers ${req.offer.quantity} ${req.offer.coinType} coin(s) for ${req.request.quantity} ${req.request.coinType} coin(s) ‚Äì Expires in ${minutesLeft} min`;
          if (auth.currentUser && auth.currentUser.uid !== req.requesterUid) {
            html += ` <button onclick="acceptTrade('${key}')">Accept Trade</button>`;
          }
          html += `</p>`;
          listDiv.innerHTML += html;
        });
      });
    }
    listenTradeRequests();
    function acceptTrade(key) {
      const user = auth.currentUser;
      if (!user) { alert("Must be logged in."); return; }
      db.ref("tradeRequests/" + key).once("value").then(snap => {
        const req = snap.val();
        if (!req) { alert("Trade does not exist."); return; }
        if (Date.now() > req.expiration) { alert("Trade expired."); return; }
        db.ref("tradeRequests/" + key).remove();
        alert("Trade accepted!");
      });
    }
    function cleanupExpiredTradeRequests() {
      db.ref("tradeRequests").once("value").then(snap => {
        const data = snap.val();
        if (!data) return;
        Object.entries(data).forEach(([key, req]) => {
          if (Date.now() > req.expiration) {
            db.ref("tradeRequests/" + key).remove();
          }
        });
      });
    }
    setInterval(cleanupExpiredTradeRequests, 60000);
    
    // ---- Audio Controls ----
    let muted = localStorage.getItem("vaultAudioMuted") === "true";
    function toggleAudio() {
      muted = !muted;
      localStorage.setItem("vaultAudioMuted", muted);
      document.getElementById("bgMusic").muted = muted;
    }
    function playSFX(id) {
      const audio = document.getElementById(id);
      if (!muted && audio) {
        audio.pause();
        audio.currentTime = 0;
        audio.play().catch(e => console.warn("Audio error:", e));
      }
    }
    
    // ---- Market & Ticker Updates (Simplified) ----
    function updateMintedStats() {
      db.ref("mintRegistry").once("value").then(snap => {
        const data = snap.val() || {};
        let totalText = "Total Minted: ";
        let todayText = "Minted Today: ";
        const todayStr = new Date().toISOString().split("T")[0];
        for (let key in data) {
          const coin = data[key];
          totalText += coin.rarity + ": 1   ";
          if (coin.date.split("T")[0] === todayStr) todayText += coin.rarity + ": 1   ";
        }
        document.getElementById("totalMinted").textContent = totalText;
        document.getElementById("todayMinted").textContent = todayText;
      });
    }
    setInterval(updateMintedStats, 60000);
    updateMintedStats();
    
    // PLACE BLOCK HERE: Additional systems such as Investment Logic and Guild/Association management can be added in future versions.
    
  </script>
</body>
</html>
