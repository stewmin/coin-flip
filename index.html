<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Fixed viewport for mobile without scrolling -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Coin Mint Vault</title>
    <!-- Google Fonts for a medieval-retro look -->
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Press+Start+2P&display=swap" rel="stylesheet" />
    <!-- Firebase libraries (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
    <style>
      /* Basic mobile-friendly styling with a “castle wall” feel */
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: 'Press Start 2P', 'MedievalSharp', sans-serif;
        background: url('stone-wall.jpg') repeat, linear-gradient(135deg, #666, #333);
        background-size: cover;
        color: #fdf6e3;
      }
      header {
        background: #444;
        text-align: center;
        padding: 10px;
        border-bottom: 3px solid #d4af37;
        font-size: 1.2em;
        letter-spacing: 1px;
      }
      /* The main game container takes up remaining height */
      #gameScreen {
        flex: 1;
        position: relative;
        overflow: hidden;
      }
      /* Modules represent full screens – only one shows at a time */
      .module {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        background: rgba(50, 50, 50, 0.95);
        padding: 10px;
        box-sizing: border-box;
      }
      .module:not(.activeModule) {
        display: none;
      }
      /* Bottom Navigation */
      #navBar {
        height: 50px;
        background: #444;
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-top: 2px solid #d4af37;
      }
      #navBar button {
        background: none;
        border: none;
        color: #fdf6e3;
        font-family: 'MedievalSharp', sans-serif;
        font-size: 12px;
        padding: 5px;
      }
      footer {
        text-align: center;
        background: #444;
        padding: 5px;
        font-size: 10px;
        color: #ccc;
      }
      /* Ticker banners at the top */
      .ticker {
        background: #555;
        padding: 3px;
        font-size: 10px;
        text-align: center;
        border: 1px solid #777;
        border-radius: 4px;
        margin-bottom: 2px;
      }
      marquee {
        font-family: 'MedievalSharp', sans-serif;
      }
      /* Sections inside modules */
      .section {
        background: rgba(60, 60, 60, 0.9);
        border: 1px solid #777;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 8px;
      }
      input, button, select {
        font-family: 'Press Start 2P', 'MedievalSharp', sans-serif;
        font-size: 10px;
        padding: 4px;
        margin: 4px 0;
        border: 1px solid #777;
        border-radius: 4px;
        outline: none;
      }
      input, select {
        background: #e8e0d8;
        color: #222;
      }
      button {
        background: linear-gradient(45deg, #8b8000, #555);
        color: #fdf6e3;
        cursor: pointer;
        transition: background 0.3s;
      }
      button:hover {
        background: #7a6900;
      }
      /* Table styling (for coin listings) */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      table, th, td {
        border: 1px solid #777;
      }
      th, td {
        padding: 4px;
        text-align: center;
        font-size: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      Coin Mint Vault
    </header>

    <!-- Ticker Banners -->
    <div class="ticker"><marquee id="coinValueTicker" scrollamount="4">Coin Values: Loading...</marquee></div>
    <div class="ticker"><marquee id="circulationTicker" scrollamount="4">Circulation: Loading...</marquee></div>

    <!-- Notifications Area -->
    <div class="section" id="notificationsBox">
      <button onclick="app.toggleNotifications()">✉️</button>
      Notifications: <span id="notificationsContent">None</span>
      <div id="notificationDropdown"></div>
    </div>

    <!-- Main Game Screen Container -->
    <div id="gameScreen">
      <!-- Vault Module -->
      <div id="VaultModule" class="module activeModule">
        <div class="section" id="userInfo">
          <p>Cash: $<span id="cashDisplay">1000</span></p>
          <p id="netWorthDisplay">Net Worth: Calculating...</p>
          <div id="vaultClockDisplay">Vault Clock: Loading...</div>
        </div>
        <div class="section" id="mintingSection">
          <h3>Mint a Coin</h3>
          <button id="mintBtn" onclick="app.mintNewCoin()">Mint Coin</button>
          <div id="mintedCoinDisplay"></div>
        </div>
        <div class="section" id="vaultSection">
          <h3>My Vault</h3>
          <div id="vaultCoins">Loading coins...</div>
        </div>
      </div>
      
      <!-- Market Module -->
      <div id="MarketModule" class="module">
        <div class="section" id="marketInterface">
          <h3>Market Listings</h3>
          <button onclick="app.loadMarketListings()">Refresh Market</button>
          <div id="marketListings">Loading market...</div>
        </div>
        <div class="section">
          <h3>List a Coin for Sale</h3>
          <div id="listableCoins">Loading your coins...</div>
        </div>
      </div>
      
      <!-- Chat Module -->
      <div id="ChatModule" class="module">
        <div class="section" id="chatMessages">Loading chat...</div>
        <div class="section" id="chatInputSection">
          <input type="text" id="chatInput" placeholder="Enter message..." style="width:80%;" />
          <button onclick="app.sendChat()">Send</button>
        </div>
      </div>
    </div>
    
    <!-- Bottom Navigation Bar -->
    <nav id="navBar">
      <button onclick="switchModule('VaultModule')">Vault</button>
      <button onclick="switchModule('MarketModule')">Market</button>
      <button onclick="switchModule('ChatModule')">Chat</button>
    </nav>
    
    <footer>
      <p>&copy; 2025 Coin Mint Vault</p>
    </footer>
    
    <!-- Audio Elements -->
    <audio id="bgMusic" loop>
      <source src="bg-music.mp3" type="audio/mpeg" />
    </audio>
    <audio id="sfxMint">
      <source src="sfx-mint.mp3" type="audio/mpeg" />
    </audio>
    
    <!-- Consolidated Script -->
    <script>
      // Module Switch Function for Bottom Navigation
      function switchModule(moduleId) {
        const modules = document.getElementsByClassName('module');
        for (let i = 0; i < modules.length; i++) {
          modules[i].classList.remove('activeModule');
          modules[i].style.display = "none";
        }
        document.getElementById(moduleId).classList.add('activeModule');
        document.getElementById(moduleId).style.display = "block";
      }
      
      // Firebase configuration – replace with your actual config
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        databaseURL: "YOUR_DATABASE_URL",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();
      
      const app = {
        currentCash: 1000,
        marketPrices: { Copper: 1, Silver: 5, Gold: 10, Platinum: 25, Diamond: 50, Iridium: 75, Rhodium: 100 },
        coinSerial: 0,
        
        // --- Simple Authentication using Anonymous Sign-In ---
        login: () => {
          auth.signInAnonymously().catch((error) => {
            console.error("Error during sign in:", error);
          });
        },
        logout: () => {
          auth.signOut();
        },
        
        // --- Update Vault Clock and Net Worth (simple timer) ---
        updateVaultClock: () => {
          const now = new Date();
          const seconds = now.getSeconds().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');
          document.getElementById("vaultClockDisplay").textContent = `Time: ${minutes}:${seconds}`;
          app.updateNetWorth();
        },
        updateNetWorth: () => {
          // Sum cash and coin values (use fixed prices)
          const user = auth.currentUser;
          if (!user) return;
          db.ref("users/" + user.uid + "/coins").once("value").then((snap) => {
            const coins = snap.val() || {};
            let total = 0;
            Object.values(coins).forEach((coin) => {
              if (coin && coin.rarity) total += app.marketPrices[coin.rarity];
            });
            const net = app.currentCash + total;
            document.getElementById("netWorthDisplay").textContent = `Net Worth: $${net.toFixed(2)}`;
          });
        },
        
        // --- Minting Coins ---
        mintNewCoin: () => {
          const user = auth.currentUser;
          if (!user) return;
          app.coinSerial++;
          const rarities = ["Copper", "Silver", "Gold", "Platinum", "Diamond", "Iridium", "Rhodium"];
          // Use basic probability to pick rarity – for simplicity, randomly pick one
          const rarity = rarities[Math.floor(Math.random() * rarities.length)];
          const coinData = { serial: app.coinSerial, rarity: rarity, date: new Date().toISOString() };
          // Save coin in user's vault
          db.ref("users/" + user.uid + "/coins").push(coinData);
          // Play mint sound
          const mintSFX = document.getElementById("sfxMint");
          mintSFX.play();
          // Update Vault UI
          app.loadVault();
        },
        
        // --- Load and Display User Vault ---
        loadVault: () => {
          const user = auth.currentUser;
          if (!user) return;
          db.ref("users/" + user.uid + "/coins").once("value").then((snap) => {
            const coins = snap.val() || {};
            let html = "<ul>";
            for (const key in coins) {
              const coin = coins[key];
              html += `<li>${coin.rarity} (#${coin.serial}) 
                <button onclick="app.listCoinForSale('${key}', '${coin.rarity}')">List for Sale</button>
              </li>`;
            }
            html += "</ul>";
            document.getElementById("vaultCoins").innerHTML = html;
          });
        },
        
        // --- Market: List a Coin for Sale ---
        listCoinForSale: (coinKey, rarity) => {
          const user = auth.currentUser;
          if (!user) return;
          // Remove coin from user's vault and add to market
          db.ref("users/" + user.uid + "/coins/" + coinKey).remove().then(() => {
            // Use fixed price from marketPrices
            const price = app.marketPrices[rarity];
            const marketEntry = {
              sellerUid: user.uid,
              coin: { rarity: rarity, serial: app.coinSerial },
              price: price,
              listedAt: Date.now(),
              fulfilled: false
            };
            db.ref("marketListings").push(marketEntry);
            alert(`Coin listed for $${price}`);
            // Refresh vault and market listings
            app.loadVault();
            app.loadMarketListings();
          });
        },
        
        // --- Load and Display Market Listings ---
        loadMarketListings: () => {
          db.ref("marketListings").orderByChild("listedAt").once("value").then((snap) => {
            const listings = snap.val() || {};
            let html = "<ul>";
            for (const key in listings) {
              const lst = listings[key];
              if (!lst.fulfilled) {
                html += `<li>${lst.coin.rarity} (#${lst.coin.serial}) - $${lst.price}
                  <button onclick="app.buyCoin('${key}', ${lst.price})">Buy</button>
                </li>`;
              }
            }
            html += "</ul>";
            document.getElementById("marketListings").innerHTML = html;
          });
        },
        
        // --- Buy a Coin from the Market ---
        buyCoin: (marketKey, price) => {
          const buyer = auth.currentUser;
          if (!buyer) return;
          db.ref("users/" + buyer.uid).once("value").then((snap) => {
            const buyerData = snap.val();
            if (buyerData.cash < price) {
              alert("Not enough cash.");
              return;
            }
            const newCash = buyerData.cash - price;
            db.ref("users/" + buyer.uid).update({ cash: newCash });
            // Transfer coin to buyer's vault and mark listing as fulfilled
            db.ref("marketListings/" + marketKey).once("value").then((snapListing) => {
              const listing = snapListing.val();
              db.ref("users/" + buyer.uid + "/coins").push(listing.coin);
              db.ref("marketListings/" + marketKey).update({ fulfilled: true });
              alert("Purchase successful!");
              app.updateUserCash();
              app.loadVault();
              app.loadMarketListings();
            });
          });
        },
        
        // --- Chat: Send and Load Messages ---
        sendChat: () => {
          const user = auth.currentUser;
          if (!user) return;
          const messageText = document.getElementById("chatInput").value;
          if (messageText.trim() === "") return;
          const messageData = {
            sender: user.uid,
            text: messageText,
            timestamp: Date.now()
          };
          db.ref("chatMessages").push(messageData);
          document.getElementById("chatInput").value = "";
          app.loadChat();
        },
        loadChat: () => {
          db.ref("chatMessages").orderByChild("timestamp").limitToLast(20).once("value").then((snap) => {
            const messages = snap.val() || {};
            let html = "<ul>";
            for (const key in messages) {
              const msg = messages[key];
              html += `<li>[${new Date(msg.timestamp).toLocaleTimeString()}] ${msg.sender.substring(0, 6)}: ${msg.text}</li>`;
            }
            html += "</ul>";
            document.getElementById("chatMessages").innerHTML = html;
          });
        },
        
        // --- Ticker Updates ---
        updateCoinValueTicker: () => {
          let txt = "";
          for (const rarity in app.marketPrices) {
            const price = app.marketPrices[rarity];
            txt += `${rarity}: $${price.toFixed(2)} | `;
          }
          document.getElementById("coinValueTicker").innerHTML = "Coin Values: " + txt;
        },
        updateCirculationTicker: () => {
          db.ref("users").once("value").then((snap) => {
            const users = snap.val() || {};
            let counts = { Copper: 0, Silver: 0, Gold: 0, Platinum: 0, Diamond: 0, Iridium: 0, Rhodium: 0 };
            Object.values(users).forEach(user => {
              if (user.coins) {
                Object.values(user.coins).forEach(coin => {
                  if (coin && coin.rarity) counts[coin.rarity]++;
                });
              }
            });
            let txt = "";
            for (const r in counts) {
              txt += `${r}: ${counts[r]} | `;
            }
            document.getElementById("circulationTicker").innerHTML = "Circulation: " + txt;
          });
        },
        
        // --- Update Minted Stats (for internal tracking) ---
        updateMintedStats: () => {
          // For simplicity, we do nothing here but this function can be expanded.
        },
        
        // --- Toggle Notifications (very simple) ---
        toggleNotifications: () => {
          const dropdown = document.getElementById("notificationDropdown");
          if (dropdown.style.display === "none" || dropdown.style.display === "") {
            dropdown.style.display = "block";
            dropdown.innerHTML = "No new notifications.";
          } else {
            dropdown.style.display = "none";
          }
        }
      };

      // Setup Firebase Auth Listener and initial load
      auth.onAuthStateChanged((user) => {
        if (user) {
          // Ensure a user entry exists in the database.
          db.ref("users/" + user.uid).once("value").then((snap) => {
            if (!snap.exists()) {
              db.ref("users/" + user.uid).set({ cash: app.currentCash });
            } else {
              const data = snap.val();
              app.currentCash = data.cash || app.currentCash;
            }
            app.updateUserCash();
            app.loadVault();
            app.loadMarketListings();
          });
          // Also load chat messages immediately.
          app.loadChat();
        } else {
          app.login();
        }
      });

      // Start some intervals
      setInterval(app.updateVaultClock, 1000);
      setInterval(app.updateMarketPrices, 60000);
      setInterval(app.updateMarketListings, 30000);
      setInterval(app.loadChat, 10000);
      
      // Expose app globally
      window.app = app;
    });
    </script>
  </body>
</html>
